#!/bin/bash
set -e

# ---------------------------------------------
# –°–∫—Ä–∏–ø—Ç: deploy-stack.sh
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
# –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç (–∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç) —Å—Ç–µ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ Docker Swarm
# –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–π–ª–∞ docker-stack.yml, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.
#
# üìå –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   - Swarm –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (docker swarm init)
#   - –§–∞–π–ª docker-stack.yml –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
#
# üß™ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
#   ./scripts/swarm/deploy-stack.sh mystack
#
# –ì–¥–µ:
#   mystack ‚Äî –∏–º—è, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º —Å—Ç–µ–∫ –±—É–¥–µ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç (–º–æ–∂–Ω–æ –ª—é–±–æ–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: infra, prod, bots)
#
# ---------------------------------------------

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(realpath "$SCRIPT_DIR/..")"
cd "$PROJECT_ROOT"

# –ò–º—è —Å—Ç–µ–∫–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî mystack
STACK_NAME=${1:-mystack}

echo "üöÄ –î–µ–ø–ª–æ–π —Å—Ç–µ–∫–∞ '$STACK_NAME' –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $PROJECT_ROOT ..."
docker stack deploy -c docker-stack.yml "$STACK_NAME"
